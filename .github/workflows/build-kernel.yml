name: Build Rock5B Radxa Kernel

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Kernel branch to build'
        required: true
        default: 'vendor-radxa'
        type: choice
        options:
          - vendor-radxa

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:  # 添加权限配置
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc "/usr/local/share/boost" "$AGENT_TOOLSDIRECTORY"
          df -h

      # =================================================================================
      # [新增步骤] 动态同步 Radxa 官方内核信息与补丁
      # 自动反推 Hash 对应的分支名，以解决 Armbian 不识别 Hash 的问题
      # 这将修改本地的 userpatches/lib.config 并注入 Patch，随后会被复制到构建目录
      # =================================================================================
      - name: Sync Configuration with Radxa Official
        run: |
          echo ">>> 正在拉取 Radxa 官方打包项目信息..."
          # 临时克隆官方打包仓库
          git clone --recursive https://github.com/radxa-pkg/linux-rk2410 radxa_pkg_temp
          
          # 1. 提取 Git URL
          RADXA_GIT_URL=$(git -C radxa_pkg_temp config --file .gitmodules --get submodule.src.url)
          
          # 2. 进入 src 目录自动反推分支名
          cd radxa_pkg_temp/src
          
          # [关键] 必须 fetch 才能获知远程分支信息，否则 submodule 处于 detached 状态不知所属分支
          echo ">>> 正在获取远程分支信息..."
          git fetch origin --tags
          
          # 获取当前锁定的 Commit SHA (用于日志记录)
          CURRENT_SHA=$(git rev-parse HEAD)
          
          # [核心逻辑] 查找包含当前 Commit 的远程分支
          # -r: 远程分支
          # --contains: 包含当前 HEAD 的分支
          # grep: 优先匹配 linux-6.1-stan 这种标准命名的分支
          # head -n 1: 如果有多个，取第一个
          # sed: 去掉 origin/ 前缀和空格
          DETECTED_BRANCH=$(git branch -r --contains HEAD | grep "linux-" | head -n 1 | sed 's/.*origin\///' | xargs)
          
          # 如果没找到（比如是 tag），尝试查找 tag
          if [ -z "$DETECTED_BRANCH" ]; then
             DETECTED_BRANCH=$(git describe --tags --exact-match 2>/dev/null || echo "")
          fi
          
          # 如果还是空的，为了防止报错，强制使用一个默认值（虽然大概率不会发生）
          if [ -z "$DETECTED_BRANCH" ]; then
             echo "⚠️ 警告: 无法自动检测分支，回退到默认值 linux-6.1-stan-rkr4.1"
             DETECTED_BRANCH="linux-6.1-stan-rkr4.1"
          fi
          
          cd ../..
          
          echo "----------------------------------------"
          echo "Kernel URL:     $RADXA_GIT_URL"
          echo "Locked SHA:     $CURRENT_SHA"
          echo "Detected Branch: $DETECTED_BRANCH"
          echo "----------------------------------------"

          # 3. 动态修改 userpatches/lib.config
          echo ">>> 更新 userpatches/lib.config..."
          
          # 替换 KERNELSOURCE
          sed -i "s|declare -g KERNELSOURCE=.*|declare -g KERNELSOURCE=\"$RADXA_GIT_URL\"|g" userpatches/lib.config
          
          # 替换 KERNELBRANCH 为自动检测到的分支名
          sed -i "s|declare -g KERNELBRANCH=.*|declare -g KERNELBRANCH=\"$DETECTED_BRANCH\"|g" userpatches/lib.config
          
          # [重要] 恢复 shallow 设置？
          # 由于我们现在提供的是分支名，Armbian 可以正常 fetch，可以尝试开启 shallow 加速
          # 但为了稳妥（防止分支有变动导致 SHA 对应不上），建议依然保持注释掉 shallow，或者仅在分支极新时开启。
          # 这里为了安全起见，我们依然注释掉它，保证完整克隆。
          sed -i "s|declare -g KERNEL_GIT=\"shallow\"|# declare -g KERNEL_GIT=\"shallow\"|g" userpatches/lib.config

          # 4. 注入官方补丁
          TARGET_PATCH_DIR="userpatches/kernel/rockchip-rk3588-radxa"
          echo ">>> 同步补丁至: $TARGET_PATCH_DIR"
          rm -rf $TARGET_PATCH_DIR
          mkdir -p $TARGET_PATCH_DIR
          cp radxa_pkg_temp/debian/patches/*.patch $TARGET_PATCH_DIR/
          
          # 清理
          rm -rf radxa_pkg_temp
          
          echo ">>> lib.config 修改完成，内容预览："
          cat userpatches/lib.config

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential python3 python3-dev python3-pip \
            wget curl ccache debootstrap qemu-user-static uuid-dev libssl-dev bc \
            cpio rsync kmod pkg-config lzop whiptail dialog

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: rock5b-kernel-${{ github.run_id }}
          restore-keys: rock5b-kernel-
          max-size: 5G

      - name: Clone Armbian Build
        run: |
          git clone https://github.com/armbian/build.git armbian-build

      # 此时 userpatches 已经被上面的步骤修改过了，包含了最新的 SHA 和 Patches
      - name: Copy userpatches
        run: |
          cp -r userpatches armbian-build/

      - name: Copy kernel config
        run: |
          cp config/kernel/linux-rockchip-rk3588-vendor-radxa.config \
             armbian-build/config/kernel/

      - name: Configure board
        run: |
          cd armbian-build
          # 确保 vendor-radxa 分支在 conf 中被允许
          sed -i 's/KERNEL_TARGET="vendor,edge"/KERNEL_TARGET="vendor,edge,vendor-radxa"/' config/boards/rock-5b.conf || true
          # 如果配置文件不存在则复制
          #if [ ! -f "config/kernel/linux-rockchip-rk3588-vendor-radxa.config" ]; then
          #  cp config/kernel/linux-rockchip-rk3588-vendor.config \
          #     config/kernel/linux-rockchip-rk3588-vendor-radxa.config
          #fi

      - name: Build kernel
        run: |
          cd armbian-build
          export CCACHE_DIR=$HOME/.ccache
          export PATH="/usr/lib/ccache:$PATH"
          ./compile.sh kernel BOARD=rock-5b BRANCH=vendor-radxa USE_CCACHE=yes 

      - name: Upload kernel packages
        uses: actions/upload-artifact@v4
        with:
          name: rock5b-kernel-debs
          path: armbian-build/output/debs/*.deb
          retention-days: 30

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: armbian-build/output/logs/
          retention-days: 7

      - name: Generate build timestamp
        id: timestamp
        run: echo "TIMESTAMP=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kernel-${{ steps.timestamp.outputs.TIMESTAMP }}
          name: Rock5B Kernel ${{ steps.timestamp.outputs.TIMESTAMP }}
          body: |
            ## Rock5B Radxa Kernel Build (Auto Sync)
            
            **构建来源**
            - 基准项目: `radxa-pkg/linux-rk2410`
            - Kernel Git: 动态获取 (见构建日志)
            - Kernel Commit: 动态获取 (与官方固件一致)
            - Patch set: 自动同步官方 patches
            
            **编译信息**

            - 编译时间: `${{ steps.timestamp.outputs.TIMESTAMP }}` (UTC)
            - 触发方式: `${{ github.event_name }}`


            **功能特性**
            - ✅ Rockchip ISP 摄像头支持
            - ✅ Mali Valhall GPU 驱动 (G610)
            - ✅ Rockchip NPU 加速 (rknpu2)
            - ✅ IMX219 摄像头传感器

            **安装指南**
            
            ### 1. 下载并安装内核
            ```bash
            # 下载所有 .deb 文件
            wget https://github.com/${{ github.repository }}/releases/download/kernel-${{ steps.timestamp.outputs.TIMESTAMP }}/*.deb
            
            # 安装内核
            sudo dpkg -i linux-image-*.deb linux-headers-*.deb linux-dtb-*.deb
            ```
            
            ### 2. 更新引导
            ```bash
            sudo update-initramfs -c -k $(uname -r)
            sudo armbian-install  # 更新bootloader，一定要这么做，先别重启！！
            ```
            
            ### 3. 重启验证
            ```bash
            sudo reboot
            uname -a  # 检查内核版本
            dmesg | grep -E "isp|mali|npu|imx219"  # 验证驱动加载
            # armbian-config里面开启imx219或者对应的树莓派摄像头V2
            # 安装camera-engine-rkaiq_xxx.deb并启动
            # systemctl start rkaiq_3A.service
            # systemctl status rkaiq_3A.service

            ```
            
            **包含的文件**
            - `linux-image-*.deb` - 内核镜像
            - `linux-headers-*.deb` - 内核头文件（编译模块用）
            - `linux-dtb-*.deb` - 设备树文件
            
            **⚠️重要提示**
            - 安装前建议备份重要数据
            - 安装后务必执行 `sudo armbian-install` 更新bootloader
            - 如遇启动问题，可在U-Boot倒计时按空格键选择旧内核
            
            **构建日志**
            - 详细日志请查看 Actions 运行记录
            - Artifact: `rock5b-kernel-debs-${{ steps.timestamp.outputs.TIMESTAMP }}`
            

          files: armbian-build/output/debs/*.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

